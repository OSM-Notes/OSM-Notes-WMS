name: Run Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgis/postgis:15-3.3
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      TEST_DBNAME: osm_notes_wms_test
      TEST_DBUSER: testuser
      TEST_DBPASSWORD: testpass
      TEST_DBHOST: localhost
      TEST_DBPORT: 5432
      PGPASSWORD: testpass
      DBNAME: osm_notes_wms_test
      DBUSER: testuser
      DBPASSWORD: testpass
      DBHOST: localhost
      DBPORT: 5432
      MOCK_MODE: 0

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install BATS
      run: |
        sudo apt-get update
        sudo apt-get install -y bats

    - name: Install PostgreSQL client tools
      run: |
        sudo apt-get install -y postgresql-client

    - name: Wait for PostgreSQL to be ready
      run: |
        until pg_isready -h localhost -U testuser -d postgres; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done
        echo "PostgreSQL is ready!"

    - name: Create test database
      run: |
        PGPASSWORD=testpass createdb -h localhost -U testuser osm_notes_wms_test || echo "Database may already exist"
        PGPASSWORD=testpass psql -h localhost -U testuser -d osm_notes_wms_test -c "CREATE EXTENSION IF NOT EXISTS postgis;"
        echo "Test database created and PostGIS extension enabled"

    - name: Make scripts executable
      run: |
        find bin -type f -name "*.sh" -exec chmod +x {} \;
        find tests -type f -name "*.sh" -exec chmod +x {} \;
        find tests -type f -name "*.bats" -exec chmod +x {} \;

    - name: Run unit tests
      continue-on-error: true
      run: |
        echo "=========================================="
        echo "Running unit tests"
        echo "=========================================="
        bats -r tests/unit/bash/ || echo "Some unit tests may have failed"
        echo "Unit tests completed"

    - name: Run integration tests
      continue-on-error: true
      run: |
        echo "=========================================="
        echo "Running integration tests"
        echo "=========================================="
        bats -r tests/integration/ || echo "Some integration tests may have failed"
        echo "Integration tests completed"

    - name: Test summary
      if: always()
      run: |
        echo "=========================================="
        echo "Test execution completed"
        echo "=========================================="
        echo "Check the output above for detailed test results."

